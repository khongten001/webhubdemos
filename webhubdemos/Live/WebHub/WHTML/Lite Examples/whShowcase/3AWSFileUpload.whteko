<!DOCTYPE whteko PUBLIC "-//HREF//DTD whteko stage 2.14//Strict//EN//" "http://static.webhub.com/dtd/0214/whteko.dtd">
<whteko defaultlingvo="eng" designmode="code">

<whdoc for="pgAWSStartFileUpload">
This example has been inspired from
http://docs.aws.amazon.com/AmazonS3/latest/dev/HTTPPOSTForms.html
27-May-2016
</whdoc>
<whdroplet name="drShowcaseFileUploadPolicy">
{"expiration":"2016-08-01T12:00:00.000Z","conditions":[{"bucket":"protected-files.demos.href.com"},["starts-with","$key","user/webhubdemos/showcase/"],{"acl":"authenticated-read"},["starts-with","$success_action_redirect","(~Request.Scheme~)://(~Request.Host~)/"],["starts-with","$Content-Type","image/"],{"Cache-Control":"max-age=2419200"},["content-length-range",0,400000]]}
</whdroplet>

<whpage pageid="pgAWSStartFileUpload" desc="Upload files directly to AWS S3">
<whpagesettings>
</whpagesettings>
(~drShowcaseGlobalHeader~)

<h2>File Upload</h2>
<p>References:</p>
<ol>
<li> <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/HTTPPOSTForms.html">AWS Docs, file upload details</a> </li>
<li> <a href="https://aws.amazon.com/articles/1434">Browser Uploads to S3: overview</a></li>
<li> <a href="http://needs-be.blogspot.com/2016/05/how-to-set-up-and-serve-private-content.html">How to Set Up and Serve Private Content</li>
<li> <a href="http://needs-be.blogspot.com/2016/06/using-openssl-on-windows-to-sign-file.html">OpenSSL on Windows for File Upload</a> </li>
<li> <a href="https://www.chilkatsoft.com/delphiDll.asp">Download Chilkat RSA wrapper</a>. This is recommended if you want to 
protect the download of the items as shown on the next page. </li>
<li> <a href="https://www.openssl.org/docs/manmaster/crypto/EVP_SignInit.html">OpenSSL manual, EVP_SignInit function</a> </li>
</ol>

      <div>
	<h3>Select a JPEG image to upload</h3>
	<p>Notes: Maximum allowed filesize is currently <b>400,000 bytes</b>; please select JPG image with a <b>lowercase file extension</b>
on your local system; and, you will need to accept Amazon's https certificate on the results page. The Cache-Control header will be set to 
4 weeks, so if you upload the same filename twice in the same month using different content, you should see the cached, older content.</p>
	
	<form method="post" accept-charset="UTF-8" 
	action="https://protected-files.demos.href.com.s3.amazonaws.com" enctype="multipart/form-data">
	
	    <input type="hidden" name="key" value="user/webhubdemos/showcase/${filename}" />
	    <input type="hidden" name="acl" value="authenticated-read" />
	    <input type="hidden" name="success_action_redirect" value="(~Request.Scheme~)://(~Request.Host~)(~DynURL.ToAppID~):pgAWSFileUploadSuccess:(~RawSessionNumber~):" />
	    <input type="hidden" name="Content-Type" value="image/jpeg" /><br />
	    <input type="hidden" name="Cache-Control" value="max-age=2419200"<!---4 weeks -->/><br />
	    <input type="hidden" name="AWSAccessKeyId" value="AKIAISE6ZP6AFHGQJX7Q" />
	    <input type="hidden" name="policy" value="(~Code64String|in-stripwhitespace,out-nocrlf; (~drShowcaseFileUploadPolicy~)~)" />

		<input type="hidden" name="signature" 
		value="(~AWSSignature2|(~drShowcaseFileUploadPolicy~); (~waTextFileContent.Execute|(~AppSetting.TextFileContent-FileUploadSecret~)~)~)" />

	    File to upload to S3: <input type="file" name="file" accept="image/jpeg" /> <br />

	    <!--- All elements after the FILE will be ignored so just go to the SUBMIT button now. -->
	    <input type="submit" name="btnSubmit" value="Upload to Amazon S3" />

	</form>
      </div>

(~drShowcaseGlobalFooter~)
</whpage>

<whmacros>
mcCloudFrontRestrictIP=(~MATCH|(~ZMDefaultMapContext~)=DEMOS|(~Request.RemoteAddress~)||(~AppSetting.AWSCloudFrontAllowIP~)~)
</whmacros>

<whpage pageid="pgAWSFileUploadSuccess" desc="-Successful File Upload">
<whpagesettings>
</whpagesettings>
(~drShowcaseGlobalHeader~)

<h2>Successful File Upload</h2>
(~CentralInfo.WebTimeUTC~)
<p>Congratulations! Your file has been uploaded to S3.</p>
<!-- WebHub Command String: (~Command~) -->
<p><b>(~waAWSKey2Filename.Execute|user/webhubdemos/showcase/~)</b></p>
<p>If you uploaded a jpg image whose file extension was in lowercase on your own system, it should appear
here for you to view:</p>
<div style="padding-bottom: 2em;">
<img style="border: solid 1px blue; padding: 0.1em;" src="//dzow0j4xohakn.cloudfront.net/user/webhubdemos/showcase/(~waAWSKey2Filename.Execute|user/webhubdemos/showcase/~)?Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cDovL2R6b3cwajR4b2hha24uY2xvdWRmcm9udC5uZXQvdXNlci93ZWJodWJkZW1vcy9zaG93Y2FzZS8qLmpwZyIsIkNvbmRpdGlvbiI6eyJEYXRlTGVzc1RoYW4iOnsiQVdTOkVwb2NoVGltZSI6MTUyMjU5MTM4NH19fV19&Signature=XsxDpcBev5adIQSL11MrfZiF5lRKyO9zefVNN2DbjfBC0kaNZ1WP~bFNxE4lh9~REXkMWeNcFEgLPxt-V7RoQJIEYg~VvdQIkYgjMrKTIIbX6o2nc41aUlNvNDtXaAey27NAYfMu0ev3lEJS0K7lonRce9uOG2TF-zNeONJwUhSqS689gab2BuVtjWN8oq2jy7Kfxqsor9F144HYwaWCfwM4j-DYad4ptFZZ75MoUXXxiakO-uCdvwHvGymp8sc4537hNYwmHSP4nWJhhMWqP-ICIwHM7mfrPb7hm1ozcQhQ6lp-EtWDjHha8wt42S3lkeh0mDLZzo3XSz0fgJFboQ__&Key-Pair-Id=APKAIGAY3EJC77HVGRFQ" alt="uploaded image" />
<br/>#1. URL for showcase/*.jpg is allowed until April 2018
</div>

<h4>Upload Policy</h4>
<p>This is the policy json used to enable your upload:</p>
<pre id="preUploadPolicy">
<script>
document.getElementById('preUploadPolicy').innerHTML = JSON.stringify((~drShowcaseFileUploadPolicy~), null, 4); /* indented with 4 spaces */
</script>
</pre>

<h4>Weak Control: Download is Partially Protected</h4>
<p>Optionally, content uploaded to S3 can be protected such that it is not available to the public.  
Files are slightly protected, in this demo.</p>
<p>Your graphic is not available through direct download, ie. this link 
will give you an Access Denied error: 
<a href="https://protected-files.demos.href.com.s3.amazonaws.com/user/webhubdemos/showcase/(~waAWSKey2Filename.Execute|user/webhubdemos/showcase/~)">try me</a>.</p>
<p>The reason your image displays above is that its URL is uses AWS CloudFront with a signed policy.</p>

<h5>Download Policy</h5>
<p>This is the policy json used to enable your download as displayed above. 
Whitespace has been added for readability. <b>Do not use whitespace 
in the real policy that you encode.</b> This particular policy was generated by 
<a href="http://www.cloudberrylab.com/">CloudBerry Explorer from CloudBerry Lab</a>.
The expiration happens in April 2018.</p>
<pre>
{"Statement":
  [{"Resource":"http://dzow0j4xohakn.cloudfront.net/user/webhubdemos/showcase/*.jpg",
   "Condition":{"DateLessThan":{"AWS:EpochTime":1465451585}}
  }]
}
</pre>

<h5>Full Control: Dynamic Policy for a Protected File</h5>
<p>Protected URLs combine the policy, the policy signed with SHA1, and a Key-Pair-ID. 
Reference: <a href="https://en.wikipedia.org/wiki/Hash-based_message_authentication_code">HMAC</a></p>
<p>Here is an image link to your file which will work only for the next 1 minute. If you try to open it in a 
separate browser window after a minute has elapsed, you will get the Access Denied response from the Amazon S3 server.</p>
<div style="padding-bottom: 2em;">
<img style="border: solid 2px green; padding: 0.1em;" 
src="(~waAWSCloudFrontSecurityProvider.Execute|(~Request.Scheme~)://dzow0j4xohakn.cloudfront.net/user/webhubdemos/showcase/(~waAWSKey2Filename.Execute|user/webhubdemos/showcase/~) | 1 | (~mcCloudFrontRestrictIP~)/32~)" alt="uploaded image with timeout in 1 minute" />
<br/>#2. URL for this image is allowed for 1 minute for 1 ip number
</div>

<p>The policy used for the second variation of the download follows &ndash; note the presence of an IP number <b>(~mcCloudFrontRestrictIP~)</b>, 
and that the resource is your specific file rather than any wildcard *.jpg:</p>
<pre id="preDownloadPolicy">
<script>
document.getElementById('preDownloadPolicy').innerHTML = JSON.stringify((~waAWSCloudFrontSecurityProvider.Execute|policy~), null, 2); /* indented with 2 spaces */
</script>
</pre>

<p style="padding-top: 2em;">(~JUMP|pgAWSStartFileUpload|Upload Again~)</p>

(~drShowcaseGlobalFooter~)
</whpage>

</whteko>